generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  MANAGER
  TEAM_LEADER
  STAFF
}

enum Gender {
  M
  F
  OTHER
  NA
}

enum ShiftType {
  LONG_DAY
  MID_DAY
  WAKE_NIGHT
  SLEEP_IN
  CUSTOM
}

enum AuditEntityType {
  USER
  HOUSE
  SHIFT
  ASSIGNMENT
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  ASSIGN
  UNASSIGN
  OVERRIDE
}

enum AvailabilityType {
  AVAILABLE
  UNAVAILABLE
  LEAVE
}

enum ShiftApplicationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum NotificationType {
  SHIFT_ASSIGNED
  SHIFT_UNASSIGNED
  SHIFT_CHANGED
  SHIFT_EXPIRED
  APPLICATION_APPROVED
  APPLICATION_REJECTED
  AVAILABILITY_SUBMITTED
}

enum AssignmentStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
}

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  firstName    String
  lastName     String
  role         Role     @default(STAFF)
  gender       Gender   @default(NA)
  phone        String?
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  assignments         Assignment[]
  auditLogs           AuditLog[]         @relation("AuditActor")
  rotaSends           RotaSend[]         @relation("RotaSender")
  assignedBy          Assignment[]       @relation("AssignmentAssignedBy")
  editedShifts        Shift[]            @relation("ShiftLastEditedBy")
  createdAssignments  Assignment[]       @relation("AssignmentCreatedBy")
  updatedAssignments  Assignment[]       @relation("AssignmentUpdatedBy")
  availability        Availability[]
  shiftApplications   ShiftApplication[]
  notifications       Notification[]
  createdTemplates    ShiftTemplate[]    @relation("TemplateCreator")
  decidedApplications ShiftApplication[] @relation("ApplicationDecider")
}

model House {
  id        String   @id @default(cuid())
  name      String
  location  String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  shifts        Shift[]
  rotaSends     RotaSend[]
  templateItems ShiftTemplateItem[]
}

model Shift {
  id                 String    @id @default(cuid())
  houseId            String
  name               String?
  shiftType          ShiftType
  shiftDate          DateTime
  startTime          String
  endTime            String
  requiredStaffCount Int       @default(1)
  notes              String?
  lastEditedById     String?
  lastEditedAt       DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  house        House              @relation(fields: [houseId], references: [id])
  assignments  Assignment[]
  lastEditedBy User?              @relation("ShiftLastEditedBy", fields: [lastEditedById], references: [id])
  applications ShiftApplication[]
}

model Assignment {
  id           String           @id @default(cuid())
  shiftId      String
  userId       String
  assignedById String?
  createdById  String
  updatedById  String
  status       AssignmentStatus @default(PENDING)
  expiresAt    DateTime?
  respondedAt  DateTime?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  shift      Shift @relation(fields: [shiftId], references: [id])
  user       User  @relation(fields: [userId], references: [id])
  assignedBy User? @relation("AssignmentAssignedBy", fields: [assignedById], references: [id])
  createdBy  User  @relation("AssignmentCreatedBy", fields: [createdById], references: [id])
  updatedBy  User  @relation("AssignmentUpdatedBy", fields: [updatedById], references: [id])

  @@unique([shiftId, userId])
}

model AuditLog {
  id         String          @id @default(cuid())
  entityType AuditEntityType
  entityId   String
  action     AuditAction
  actorId    String?
  beforeJson Json?
  afterJson  Json?
  metadata   Json?
  createdAt  DateTime        @default(now())

  actor User? @relation("AuditActor", fields: [actorId], references: [id])
}

model RotaSend {
  id            String   @id @default(cuid())
  houseId       String
  weekStartDate DateTime
  sentAt        DateTime @default(now())
  sentById      String?

  house  House @relation(fields: [houseId], references: [id])
  sentBy User? @relation("RotaSender", fields: [sentById], references: [id])
}

model Availability {
  id        String           @id @default(cuid())
  userId    String
  type      AvailabilityType
  startDate DateTime
  endDate   DateTime
  notes     String?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model ShiftApplication {
  id          String                 @id @default(cuid())
  shiftId     String
  userId      String
  status      ShiftApplicationStatus @default(PENDING)
  decidedById String?
  decidedAt   DateTime?
  createdAt   DateTime               @default(now())
  updatedAt   DateTime               @updatedAt

  shift     Shift @relation(fields: [shiftId], references: [id])
  user      User  @relation(fields: [userId], references: [id])
  decidedBy User? @relation("ApplicationDecider", fields: [decidedById], references: [id])

  @@unique([shiftId, userId])
}

model ShiftTemplate {
  id          String   @id @default(cuid())
  name        String
  createdById String
  createdAt   DateTime @default(now())

  createdBy User                @relation("TemplateCreator", fields: [createdById], references: [id])
  items     ShiftTemplateItem[]
}

model ShiftTemplateItem {
  id                 String    @id @default(cuid())
  templateId         String
  houseId            String
  name               String?
  shiftType          ShiftType
  startTime          String
  endTime            String
  requiredStaffCount Int       @default(1)
  dayOfWeek          Int

  template ShiftTemplate @relation(fields: [templateId], references: [id])
  house    House         @relation(fields: [houseId], references: [id])
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  body      String
  data      Json?
  createdAt DateTime         @default(now())
  readAt    DateTime?

  user User @relation(fields: [userId], references: [id])
}
